{% extends 'asktoaske/partial/base.html' %}
{% load static %}

{% block index %}

<div class="container-fluid">
    <div class="message-container">
        <div class="messages mb-3">
            <div id="uploading-file" class="uploading-file" {% if form_display %} style="display: flex;" {% else %} style="display: none;" {% endif %}>
                <form id="upload-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button id="form-submitted-btn" type="submit">Upload</button>
                </form>
                <h2 style="text-align: center;">Wanted to Ask !! <br> <b>Ask to Aske</b></h2>
                <span>** Only Pdf supported **</span>
                <img src="../../../static/asktoaske/images/upload.png" alt="">
            </div>
            <div id="loading-data" class="loading-data" {% if not loading %} style="display: none;" {% else %} style="display: flex;" {% endif %}>
                <div class="dataloader">
                    <span class="dataloader-text"><b>loading Your data...</b></span>
                      <span class="dataload"></span>
                  </div>
            </div>
            <div class="conversations" id="conversations" {% if not messages %} style="display: none;" {% else %} style="display: flex;" {% endif %}>
                <div class="message-box left">
                    <p>Hello, How are you?</p>
                </div>
                <div class="message-box right">
                    <p>I'm good, thanks for asking! How about you?</p>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function() {
                $('#upload-form').on('submit', function(e) {
                    e.preventDefault();
                    
                    var formData = new FormData(this);
                    
                    $.ajax({
                        type: 'POST',
                        url: '{% url "asktoaske:asktoaske" %}',
                        data: formData,
                        processData: false,
                        contentType: false,
                        beforeSend: function(xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                        },
                        success: function(response) {
                            $('#upload-status').html('<p>Upload successful!</p>');
                            $('#upload-form')[0].reset();
                        },
                        error: function(xhr, errmsg, err) {
                            $('#upload-status').html('<p>Upload failed: ' + errmsg + '</p>');
                        }
                    });
                });
            });
        </script>
        
        <script>
            const conversations = document.getElementById('conversations');
            const sendMessageUrl = "{% url 'asktoaske:send_message' %}";
        
            function sendMessage() {
                const userInput = document.getElementById('user-input').value;
        
                // Display user's message
                conversations.innerHTML += `
                    <div class="message-box right">
                        <p>${userInput}</p>
                    </div>`;
        
                // Clear input field
                document.getElementById('user-input').value = '';
        
                // Send message to backend
                fetch(sendMessageUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ message: userInput })
                })
                .then(response => response.json())
                .then(data => {
                    let assistantReply = data.reply.replace(/\n/g, '<br>');
                    assistantReply = assistantReply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        
                    // Display assistant's response
                    conversations.innerHTML += `
                        <div class="message-box left">
                            <p>${assistantReply}</p>
                        </div>`;
                })
                .catch(error => console.error('Error:', error));
            }
        
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>
        <div class="messages-tools">
            <textarea placeholder="Enter Your query..." rows="4" name="message_query" id="message_query"></textarea>
        </div>
    </div>
</div>

{% endblock index %}